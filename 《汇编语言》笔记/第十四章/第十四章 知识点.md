# 第十四章 端口
在这一章，我们可以学到CPU不仅跟各种存储器相连接，还与一下三种芯片会有交互：

1. 各种接口卡，比如，网卡、显卡
2. 主板上的接口芯片，比如一些I/O接口
3. 其他芯片，用来存储相关的系统信息，比如后面要讲到的CMOS RAM

当然，这些芯片都拥有各自的读写寄存器，这些寄存器虽然**都不在同一个物理芯片里**，但是它们均有两个共同点:

1. 都和CPU的总线相连（通过它们所在的芯片处理）
2. CPU对它们进行读或写的时候都能通过控制线向它们所在的芯片发出端口读写命令。

![CPU对芯片的读写](https://img2018.cnblogs.com/blog/1550414/201906/1550414-20190619195730666-125010245.png)

那CPU是如何知道这些芯片的存在呢？

笔者个人猜测是主板制订的某些基础规范，哪些设备该接哪些接口，先保证系统的正常启动；然后有些通用的多样化的设备，可以让商家自行定制驱动程序，交由操作系统来读写。

那我们该如何使用这些芯片呢？

CPU会将已知的这些芯片上的寄存器进行**统一编址**，建立一个统一的**端口地址空间**（这里的端口就是代指可访问的芯片上的寄存器），每个端口（芯片）在**端口地址空间**内都有一个地址。


在学完这章节后，我们能知道CPU可以直接从以下三个地方读取数据：

1. CPU内部的寄存器
2. 内存单元（内存）
3. 端口

## 端口的读写
CPU最多可以定位 ***64KB（0~65535）** 个不同的端口，端口地址和内存地址一样可以通过地址总线进行传输。

端口的读写命令仅两条：

1. in al||ax, 端口地址
2. out 端口地址, al||ax

但是和内存访问指令的流程相差无几：

### 内存访问流程
```assemble
    mov ax, ds:[0AH]
```

1. CPU通过 **地址总线**将地址数据 *0AH* 发出（注意，这个数据在硬件里是一个**持续性**的电压，不是一次性的，请注意，不然会想不通 **CPU怎么知道把地址数据发到哪里** 的问题，有兴趣的可以阅读我的计算机组成原理笔记）
2. CPU通过 **控制总线** 发出内存读命令（也是一个电压），选中指定得存储器芯片，并通知他将要读取数据
3. 存器将*0AH*号单元中得数据通过数据线送入CPU

### 端口访问流程

```assemble
    in al, 60h
```

1. CPU通过 **地址总线** 锁定端口地址为60h的端口
2. CPU通过 **控制总线** 发出端口读命令，选中端口所在的芯片，并通知他将要读取数据
3. 端口所在的芯片将*60H*号端口中得数据通过数据线送入CPU

注意端口的读写指令里，**只能使用ax或al**来存放从端口中读入的 或 要发送到端口的数据。访问8位端口时用al，访问16位端口时用ax。

另外对0~255以内的端口进行读写时：
```assemble
in al, 20h
out 20h, al
```
对256~65535的端口进行读写时，端口号放在dx中：
```assemble
mov dx, 3f8h
in al, dx
out dx, al
```