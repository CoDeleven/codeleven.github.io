---
title: 存储器之高速缓冲器(Cache)
date: 2018-07-20 15:46:19
tags: 计算机组成
---

# 概要
目前CPU遇到以下两个问题：
1. 当 **I/O设备向主存请求**时，**CPU无法访问主存**，只能空等着
2. **主存速度的提高** 始终跟不上 **CPU的发展**

为了避免CPU和I/O设备争抢方寸，可在CPU与主存之间加一级Cache，此时CPU只需要跟Cache交互即可；另一方面，添加Cache还能解决主存与CPU速度的不匹配。

# 问题的提出
1. 为什么添加一个Cache可以解决主存与CPU速度的不匹配问题？
2. 既然Cache速度这么快，为什么不用 Cache 替换 主存？
3. Cache的工作原理？
4. 如何判断Cache的性能？
5. Cache的性能由哪些方面决定？
6. CPU、Cache、主存间是如何进行交互的？


## 为什么添加一个Cache可以解决主存与CPU速度的不匹配问题
因为经过数据分析，发现代码执行时是存在 **局部性**的。
局部性主要分成两部分：**时间局部性**、**空间局部性**。

* 时间局部性：CPU从主存取指令或取数据时，在一定时间内，只会对主存的部分地址区域进行访问。
* 空间局部性：由于数据在主存内都是连续存放的，所以很可能下一个即将访问的指令也在同一个区域内。

根据以上两点，只要将CPU近期要用到的程序和数据提前存到Cache中，那么CPU在一定时间内，只需要访问Cache即可。

## 既然Cache速度这么快，为什么不用 Cache 替换 主存
因为Cache一般采用SRAM制作，其价格比主存昂贵。

## Cache的工作原理
主存由2<sup>n</sup>个可编址的字组成，每个字有惟一的n位地址。
为了与Cache映射，将主存与缓存都分成若干 **块**，每个块内又包含多个 **字**，并使他们的块大小相同（即块内字数相同）。

这就将主存的地址分成了两端：**主存块号**、**块内地址**。**主存块号的位数 + 块内地址的位数 = 一个字的位数**。

除此之外，Cache中有一个“标记”。标记是用来表示当前存放的是 **哪一块主存块**。设置这个标记是因为 Cache块 **远比** 主存块 **少**，所以Cache里停留的内容不会是固定的，需要一个东西标志 某个缓存块对应的主存块。

> 不是主存地址可以通过转换获取缓存地址吗，为什么还需要标志位？因为Map需要的时间是最少的。

![Cache-主存原理](https://blog-1252749790.file.myqcloud.com/ComputerOrganization/Cache-%E4%B8%BB%E5%AD%98%E5%AD%98%E5%82%A8%E7%A9%BA%E9%97%B4.png)

## Cache的性能指标
判断Cache好坏的指标有三个：
* Cache的命中率
* Cache的平均访问时间
* Cache的访问效率

### Cache的命中率
`Cache命中率 = 命中数 / (命中数 + 未命中数)`

当CPU欲访问主存中的某块数据时，Cache中正好存在，则称为 **缓存命中**
当CPU欲访问主存中的某块数据时，Cache中不存在，则称为 **缓存不命中**

### 平均访问时间
`平均访问时间 = 命中时访问时间 * 命中率 + (1 - 命中率) * 未命中时间`

**平均访问时间** 越接近 **命中时访问时间**越好

### 访问效率
在平均访问时间的基础上，扩充出访问效率，即`访问效率 = 平均访问时间 / 命中时访问时间`

## Cache的性能由哪些方面决定
通常来说，Cache 由 **块的数量**、**块的长度**决定的。
### Cache块的数量
因为Cache的块数量够多，达到主存的块数量，那么Cache除了第一次不命中，后面都是100%命中的。
### Cache块的长度
Cache的块长则需要具体情况具体分析，因为Cache块过短，保存的数据量不够多，可以被命中的字少了，那么命中率就下降了；而Cache块过长，缓存中块数减少，可装入的块就少了，很容易出现新块 覆盖 旧块，然后因为新块被使用次数不够多，最终导致命中率下讲；另外块过长，可能会导致一些不相关的数据保存进来，白白浪费空间。
### 总结
一般来说Cache块通常取4~8个字或字节，也可以取 一个主存周期所能获得的主存信息长度。

## CPU、Cache和主存间的交互
![CPU、Cache和主存间的交互](https://blog-1252749790.file.myqcloud.com/ComputerOrganization/CPU%E3%80%81Cache%E3%80%81%E4%B8%BB%E5%AD%98%E9%97%B4%E7%9A%84%E4%BA%A4%E4%BA%92.png)